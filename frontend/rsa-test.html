<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>RSA ì•”í˜¸í™” í…ŒìŠ¤íŠ¸</title>
</head>

<body>
    <h1>RSA-OAEP/SHA-256 í…ŒìŠ¤íŠ¸</h1>
    <button onclick="testEncryption()">í…ŒìŠ¤íŠ¸ ì‹¤í–‰</button>
    <pre id="result"></pre>

    <script>
        async function testEncryption() {
            const resultEl = document.getElementById('result');
            resultEl.textContent = 'í…ŒìŠ¤íŠ¸ ì¤‘...\n';

            try {
                // 1. ê³µê°œí‚¤ ê°€ì ¸ì˜¤ê¸°
                const pubKeyResponse = await fetch('http://localhost:8080/api/crypto/public-key');
                const pubKeyData = await pubKeyResponse.json();
                const publicKeyBase64 = pubKeyData.publicKey;

                resultEl.textContent += `âœ… ê³µê°œí‚¤ ê°€ì ¸ì˜¤ê¸° ì„±ê³µ\n`;
                resultEl.textContent += `   ê¸¸ì´: ${publicKeyBase64.length}\n\n`;

                // 2. ê³µê°œí‚¤ ì„í¬íŠ¸
                const binaryDer = Uint8Array.from(atob(publicKeyBase64), c => c.charCodeAt(0));
                const publicKey = await crypto.subtle.importKey(
                    'spki',
                    binaryDer,
                    {
                        name: 'RSA-OAEP',
                        hash: 'SHA-256'
                    },
                    false,
                    ['encrypt']
                );

                resultEl.textContent += `âœ… ê³µê°œí‚¤ ì„í¬íŠ¸ ì„±ê³µ\n`;
                resultEl.textContent += `   ì•Œê³ ë¦¬ì¦˜: RSA-OAEP\n`;
                resultEl.textContent += `   í•´ì‹œ: SHA-256\n\n`;

                // 3. í…ŒìŠ¤íŠ¸ ë°ì´í„° ì•”í˜¸í™”
                const testData = "HelloWorld1234567890123456789012"; // 32 bytes
                const encoder = new TextEncoder();
                const dataBytes = encoder.encode(testData);

                resultEl.textContent += `ğŸ“ í…ŒìŠ¤íŠ¸ ë°ì´í„°: "${testData}"\n`;
                resultEl.textContent += `   ê¸¸ì´: ${dataBytes.length} bytes\n\n`;

                // 4. RSA-OAEPë¡œ ì•”í˜¸í™”
                const encryptedData = await crypto.subtle.encrypt(
                    { name: 'RSA-OAEP' },
                    publicKey,
                    dataBytes
                );

                const encryptedBase64 = btoa(String.fromCharCode(...new Uint8Array(encryptedData)));

                resultEl.textContent += `âœ… RSA-OAEP ì•”í˜¸í™” ì„±ê³µ\n`;
                resultEl.textContent += `   ì•”í˜¸í™”ëœ ë°ì´í„° ê¸¸ì´: ${encryptedBase64.length}\n\n`;

                // 5. ì„œë²„ë¡œ ë³µí˜¸í™” ìš”ì²­
                const decryptResponse = await fetch('http://localhost:8080/api/crypto/test-decrypt', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        encryptedKey: encryptedBase64
                    })
                });

                const decryptResult = await decryptResponse.json();

                if (decryptResult.success) {
                    resultEl.textContent += `âœ… ì„œë²„ ë³µí˜¸í™” ì„±ê³µ!\n`;
                    resultEl.textContent += `   ë³µí˜¸í™”ëœ ë°ì´í„°: "${decryptResult.decryptedKey}"\n`;
                    resultEl.textContent += `   ì›ë³¸ê³¼ ì¼ì¹˜: ${decryptResult.decryptedKey === testData ? 'âœ… YES' : 'âŒ NO'}\n`;
                } else {
                    resultEl.textContent += `âŒ ì„œë²„ ë³µí˜¸í™” ì‹¤íŒ¨\n`;
                    resultEl.textContent += `   ì—ëŸ¬: ${decryptResult.error}\n`;
                    resultEl.textContent += `   íƒ€ì…: ${decryptResult.type}\n`;
                }

            } catch (error) {
                resultEl.textContent += `\nâŒ ì—ëŸ¬ ë°œìƒ: ${error.message}\n`;
                console.error(error);
            }
        }
    </script>
</body>

</html>